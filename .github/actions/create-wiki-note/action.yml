name: 'Create Wiki Release Note'

description: 'Creates a draft release note and updates sidebar'

inputs:
  service_name:
    required: true
    description: "Name of the microservice"
  version:
    required: true
    description: "Version number"
  token:
    required: true
    description: "GitHub Token"
  actor:
    required: true
    description: "User triggering the build"

runs:
  using: "composite"
  steps:
    - name: Create Wiki Page & Rebuild Sidebar
      shell: bash
      env:
        WIKI_REPO: https://${{ inputs.actor }}:${{ inputs.token }}@github.com/${{ github.repository }}.wiki.git
        VERSION: ${{ inputs.version }}
        SERVICE_NAME: ${{ inputs.service_name }}
        USER: ${{ inputs.actor }}
      run: |
        # --- 1. CLONE WIKI ---
        TEMP_DIR="tmp_wiki_${RANDOM}"
        if ! git clone $WIKI_REPO $TEMP_DIR; then
           echo "::error::âŒ Wiki Repo not found."
           exit 1
        fi
        cd $TEMP_DIR
        
        # --- 2. CREATE SERVICE FOLDER & NOTE ---
        mkdir -p "$SERVICE_NAME"
        FILENAME="$SERVICE_NAME/${VERSION}.md"
        
        if [ ! -f "$FILENAME" ]; then
          cat > "$FILENAME" << EOF
        # $SERVICE_NAME: $VERSION
        **Owner:** @$USER | **Date:** $(date -u +"%Y-%m-%d")
        
        ## ðŸ“ Changes
        - (Add release notes)
        
        ## ðŸ“¦ Artifacts
        - Package: \`@semir-intellisync/$SERVICE_NAME@${VERSION}\`
        EOF
        fi

        # --- 3. ðŸŒ³ SIDEBAR GENERATOR (The Magic Part) ðŸŒ³ ---
        echo "ðŸ”¹ Rebuilding Tree Sidebar..."
        
        # Start Sidebar
        echo "## ðŸ§­ Navigation" > _Sidebar.md
        echo "ðŸ“‚ [[Home]]" >> _Sidebar.md
        echo "" >> _Sidebar.md
        
        # Loop through every folder (Microservices)
        for d in */ ; do
            service_dir=${d%/} # remove trailing slash
            
            # Skip hidden folders
            if [[ "$service_dir" == "." || "$service_dir" == ".." || "$service_dir" == ".git" ]]; then continue; fi
            
            # Print Service Name (Bold)
            echo "**$service_dir**" >> _Sidebar.md
            
            # Find all .md files in this folder, sort reverse (newest top)
            # We use 'ls -r' for simple reverse sort.
            files=$(ls -r "$service_dir"/*.md 2>/dev/null)
            
            if [ -z "$files" ]; then continue; fi
            
            # Loop through versions to create the tree structure
            for f in $files; do
                # Get filename (1.0.0)
                version_name=$(basename "$f" .md)
                
                # WRITE THE TREE LINE: |__ 1.0.0
                # We use specific unicode characters for the tree look
                echo "&nbsp;&nbsp;&nbsp;â”œâ”€â”€ [$version_name]($f)" >> _Sidebar.md
            done
            
            # Add a tiny spacer after each service
            echo "" >> _Sidebar.md
        done
        
        # --- 4. PUSH CHANGES ---
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        git add .
        
        if git diff --staged --quiet; then
          echo "No changes."
        else
          git commit -m "Update Sidebar for $SERVICE_NAME $VERSION"
          git push origin master
        fi
        
        cd ..
        rm -rf $TEMP_DIR

