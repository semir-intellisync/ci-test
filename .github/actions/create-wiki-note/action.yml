name: 'Create Wiki Release Note'

description: 'Creates a draft release note and updates sidebar'

inputs:
  service_name:
    required: true
    description: "Name of the microservice"
  version:
    required: true
    description: "Version number"
  token:
    required: true
    description: "GitHub Token"
  actor:
    required: true
    description: "User triggering the build"

runs:
  using: "composite"
  steps:
    - name: Create Wiki Page & Rebuild Sidebar
      shell: bash
      env:
        WIKI_REPO: https://${{ inputs.actor }}:${{ inputs.token }}@github.com/${{ github.repository }}.wiki.git
        VERSION: ${{ inputs.version }}
        SERVICE_NAME: ${{ inputs.service_name }}
        USER: ${{ inputs.actor }}
      run: |
        # --- 1. CLONE WIKI ---
        TEMP_DIR="tmp_wiki_${RANDOM}"
        if ! git clone $WIKI_REPO $TEMP_DIR; then
           echo "::error::âŒ Wiki Repo not found."
           exit 1
        fi
        cd $TEMP_DIR
        
        # --- 2. CREATE SERVICE FOLDER & NOTE ---
        mkdir -p "$SERVICE_NAME"
        FILENAME="$SERVICE_NAME/${VERSION}.md"
        
        if [ ! -f "$FILENAME" ]; then
          cat > "$FILENAME" << EOF
        # $SERVICE_NAME: $VERSION
        **Owner:** @$USER | **Date:** $(date -u +"%Y-%m-%d")
        
        ## ğŸ“ Changes
        - (Add release notes)
        
        ## ğŸ“¦ Artifacts
        - Package: \`@semir-intellisync/$SERVICE_NAME@${VERSION}\`
        EOF
        fi

        # --- 3. ğŸŒ³ BEAUTIFUL COLLAPSIBLE SIDEBAR GENERATOR ğŸŒ³ ---
        echo "ğŸ”¹ Rebuilding Beautiful Collapsible Sidebar..."
        
        # Start Sidebar with beautiful header
        cat > _Sidebar.md << 'SIDEBAR_HEADER'
## ğŸ§­ Navigation

ğŸ“‚ [[Home|Home]]

---

### ğŸ“¦ Release Notes

<details>
<summary>
  <strong>ğŸš€ All Services</strong>
</summary>

SIDEBAR_HEADER
        
        # Loop through every folder (Microservices) - sorted alphabetically
        services=($(find . -maxdepth 1 -type d ! -name '.' ! -name '..' ! -name '.git' -exec basename {} \; | sort))
        
        for service_dir in "${services[@]}"; do
            # Find all .md files in this folder, sort reverse (newest top)
            files=($(ls -r "$service_dir"/*.md 2>/dev/null))
            
            if [ ${#files[@]} -eq 0 ]; then continue; fi
            
            # Count versions for display
            version_count=${#files[@]}
            
            # Create collapsible section for each service
            echo "" >> _Sidebar.md
            echo "<details>" >> _Sidebar.md
            echo "<summary>" >> _Sidebar.md
            echo "  ğŸ“ **$service_dir** <small>($version_count versions)</small>" >> _Sidebar.md
            echo "</summary>" >> _Sidebar.md
            echo "" >> _Sidebar.md
            
            # Loop through versions to create the beautiful tree structure
            file_count=0
            for f in "${files[@]}"; do
                file_count=$((file_count + 1))
                version_name=$(basename "$f" .md)
                
                # Determine if this is the last item
                if [ $file_count -eq ${#files[@]} ]; then
                    # Last item - use â””â”€â”€
                    tree_char="â””â”€â”€"
                else
                    # Not last - use â”œâ”€â”€
                    tree_char="â”œâ”€â”€"
                fi
                
                # Format version nicely (truncate long versions)
                display_version="$version_name"
                if [ ${#version_name} -gt 35 ]; then
                    display_version="${version_name:0:32}..."
                fi
                
                # Create beautiful tree line with link (using proper indentation)
                echo "&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #6a737d;\">$tree_char</span> ğŸ“Œ [[$f|$display_version]]" >> _Sidebar.md
            done
            
            echo "" >> _Sidebar.md
            echo "</details>" >> _Sidebar.md
        done
        
        # Close the main details section
        echo "" >> _Sidebar.md
        echo "</details>" >> _Sidebar.md
        echo "" >> _Sidebar.md
        echo "---" >> _Sidebar.md
        echo "" >> _Sidebar.md
        echo "<small>âœ¨ Auto-generated sidebar</small>" >> _Sidebar.md
        
        # --- 4. PUSH CHANGES ---
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        git add .
        
        if git diff --staged --quiet; then
          echo "No changes."
        else
          git commit -m "Update Sidebar for $SERVICE_NAME $VERSION"
          git push origin master
        fi
        
        cd ..
        rm -rf $TEMP_DIR

