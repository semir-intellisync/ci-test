name: 'Create Wiki Release Note'

description: 'Creates a draft release note and updates sidebar'

inputs:
  service_name:
    required: true
    description: "Name of the microservice"
  version:
    required: true
    description: "Version number"
  token:
    required: true
    description: "GitHub Token"
  actor:
    required: true
    description: "User triggering the build"

runs:
  using: "composite"
  steps:
    - name: Create Wiki Page & Rebuild Sidebar
      shell: bash
      env:
        WIKI_REPO: https://${{ inputs.actor }}:${{ inputs.token }}@github.com/${{ github.repository }}.wiki.git
        VERSION: ${{ inputs.version }}
        SERVICE_NAME: ${{ inputs.service_name }}
        USER: ${{ inputs.actor }}
      run: |
        TEMP_DIR="tmp_wiki_${RANDOM}"
        if ! git clone $WIKI_REPO $TEMP_DIR; then
           echo "::error::âŒ Wiki Repo not found."
           exit 1
        fi
        cd $TEMP_DIR
        
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        
        mkdir -p "$SERVICE_NAME"
        FILENAME="$SERVICE_NAME/${VERSION}.md"
        
        if [ ! -f "$FILENAME" ]; then
          cat > "$FILENAME" << EOF
        # $SERVICE_NAME: $VERSION
        **Owner:** @$USER | **Date:** $(date -u +"%Y-%m-%d")
        
        ## ðŸ“ Changes
        - (Add release notes)
        
        ## ðŸ“¦ Artifacts
        - Package: \`@semir-intellisync/$SERVICE_NAME@${VERSION}\`
        EOF
        fi

        echo "ðŸ”¹ Rebuilding Sidebar..."
        
        {
          echo "## ðŸ§­ Navigation"
          echo ""
          echo "ðŸ“‚ [[Home]]"
          echo ""
          echo "### ðŸ“¦ Release Notes"
        } > _Sidebar.md
        
        services=($(find . -maxdepth 1 -type d ! -name '.' ! -name '..' ! -name '.git' ! -name 'Releases' ! -name 'releases' -exec basename {} \; | sort))
        
        for service_dir in "${services[@]}"; do
            files=($(ls -r "$service_dir"/*.md 2>/dev/null))
            
            if [ ${#files[@]} -eq 0 ]; then continue; fi
            
            version_count=${#files[@]}
            
            echo "" >> _Sidebar.md
            echo "<details>" >> _Sidebar.md
            echo "<summary><b>$service_dir</b> ($version_count)</summary>" >> _Sidebar.md
            echo "<ul>" >> _Sidebar.md
            
            for f in "${files[@]}"; do
                version_name=$(basename "$f" .md)
                
                display_version="$version_name"
                if [ ${#version_name} -gt 25 ]; then
                    display_version="${version_name:0:22}..."
                fi
                
                echo "<li><a href='$f'>$display_version</a></li>" >> _Sidebar.md
            done
            
            echo "</ul>" >> _Sidebar.md
            echo "</details>" >> _Sidebar.md
        done

        git fetch origin master
        git pull origin master --no-rebase || git pull origin master
        
        git add .
        
        if git diff --staged --quiet; then
          echo "No changes to commit."
        else
          git commit -m "Update Sidebar for $SERVICE_NAME $VERSION"
          if ! git push origin master; then
            echo "Push failed, pulling latest and retrying..."
            git pull origin master --rebase
            git push origin master
          fi
        fi
        
        cd ..
        rm -rf $TEMP_DIR

